rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // قواعد المستخدمين
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // المحفظة
      match /wallet/{document=**} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false; // فقط من خلال Cloud Functions
      }
      
      // المكافآت
      match /rewards/{document=**} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false; // فقط من خلال Cloud Functions
      }
    }
    
    // قواعد المطاعم
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'restaurant_admin';
      
      // القائمة
      match /menu/{itemId} {
        allow read: if true;
        allow write: if request.auth != null && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'restaurant_admin';
      }
      
      // الطلبات
      match /orders/{orderId} {
        allow read: if request.auth != null && (
          request.auth.uid == resource.data.customerId ||
          request.auth.uid == resource.data.driverId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'restaurant_admin'
        );
        allow create: if request.auth != null;
        allow update: if request.auth != null && (
          request.auth.uid == resource.data.customerId ||
          request.auth.uid == resource.data.driverId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'restaurant_admin'
        );
      }
    }
    
    // قواعد المندوبين
    match /drivers/{driverId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == driverId;
      
      // التوصيلات
      match /deliveries/{deliveryId} {
        allow read: if request.auth != null && (
          request.auth.uid == driverId ||
          request.auth.uid == resource.data.customerId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        );
        allow write: if request.auth != null && request.auth.uid == driverId;
      }
    }
    
    // قواعد الطلبات العامة
    match /orders/{orderId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.customerId ||
        request.auth.uid == resource.data.driverId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.customerId ||
        request.auth.uid == resource.data.driverId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
  }
}